#!/bin/bash

ARGS="-P"
TASK="../build/reinvent_dpdk_udp_integration_test.tsk"

if [[ "$1" == "client" ]]
then
  MODE=$1
  PREFIX="TEST_CLIENT"
elif [[ "$1" == "server" ]]
then
  MODE=$1
  PREFIX="TEST_SERVER"
else
  echo "usage: reinvent_dpdk_init_udp_integration_test <client|server>"
  exit 2
fi

if [[ "$2" == "perf" ]]
then
  ARGS="-P"
  TASK="../build/reinvent_dpdk_udp_opt_integration_test.tsk"
fi

#
# Run as root
#
export LD_LIBRARY_PATH=/root/local/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}

#
# In this basic UDP test, client transmit only; server receives only
#

# -----------------------------------------------------------
# CLIENT CONFIGS
# -----------------------------------------------------------
export TEST_CLIENT_DPDK_NIC_DEVICE="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_NUMA_NODE="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_SOFT_ENABLED="TRUE"
export TEST_CLIENT_DPDK_NIC_DEVICE_PCI_DEVICE_ID="0000:01:00.1"

export TEST_CLIENT_DPDK_NIC_DEVICE_MEMZONE_RESERVE_KB="153600"
export TEST_CLIENT_DPDK_NIC_DEVICE_MEMZONE_RESERVE_MASK="5"
export TEST_CLIENT_DPDK_NIC_DEVICE_MEMZONE_RESERVE_NAME="REINVENT_AWS"
export TEST_CLIENT_DPDK_NIC_DEVICE_MEMPOOL_POLICY="PER_QUEUE"

export TEST_CLIENT_DPDK_NIC_DEVICE_MEMPOOL_RXQ_SIZE="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_MEMPOOL_RXQ_CACHE_SIZE="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_MEMPOOL_RXQ_PRIV_SIZE="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_MEMPOOL_RXQ_DATA_ROOM_SIZE="0"

export TEST_CLIENT_DPDK_NIC_DEVICE_MEMPOOL_TXQ_SIZE="10001"
export TEST_CLIENT_DPDK_NIC_DEVICE_MEMPOOL_TXQ_CACHE_SIZE="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_MEMPOOL_TXQ_PRIV_SIZE="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_MEMPOOL_TXQ_DATA_ROOM_SIZE="512"

export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_VCPU_POLICY="DISTINCT"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_VCPU_MASK="ALL"
export TEST_CLIENT_DPDK_NIC_DEVICE_TX_QUEUE_SIZE="1"
export TEST_CLIENT_DPDK_NIC_DEVICE_TX_MQ_MASK="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_TX_OFFLOAD_MASK="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_RING_SIZE="1024"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_THREAD_COUNT="QUEUE_SIZE"

export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_PTHRESH="32"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_HTHRESH="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_WTHRESH="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_RS_THRESH="32"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_FREE_THRESH="32"

export TEST_CLIENT_DPDK_NIC_DEVICE_RXQ_VCPU_POLICY="OFF"
export TEST_CLIENT_DPDK_NIC_DEVICE_RXQ_VCPU_MASK="ALL"
export TEST_CLIENT_DPDK_NIC_DEVICE_RX_QUEUE_SIZE="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_RX_MQ_MASK="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_RX_OFFLOAD_MASK="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_RXQ_RING_SIZE="1024"
export TEST_CLIENT_DPDK_NIC_DEVICE_RXQ_THREAD_COUNT="0"

export TEST_CLIENT_DPDK_NIC_DEVICE_RX_MTU="1500"
export TEST_CLIENT_DPDK_NIC_DEVICE_LINK_SPEED_MASK="0"
export TEST_CLIENT_DPDK_NIC_DEVICE_TX_DEFAULT_FLOW="2048"

export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_DEFAULT_SRC_MAC="1c:34:da:42:b8:39"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_DEFAULT_DST_MAC="1c:34:da:42:c9:01"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_DEFAULT_SRC_IP="192.168.0.3"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_DEFAULT_DST_IP="192.168.0.2"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_DEFAULT_SRC_PORT="10000"
export TEST_CLIENT_DPDK_NIC_DEVICE_TXQ_DEFAULT_DST_PORT="20000"

export TEST_CLIENT_DPDK_INITIALIZATION_PARAMETERS="--proc-type,primary,--in-memory,--log-level,7,--allow,${TEST_CLIENT_DPDK_NIC_DEVICE_PCI_DEVICE_ID}"

export TEST_CLIENT_DRAM_MEMORY_CHANNELS=4

# number of packets to be transmitted by each TXQ
export TEST_CLIENT_TXQ_PACKET_COUNT=1000

export TEST_CLIENT_VCPU_MAX=16
export TEST_CLIENT_VCPU_0_SOFT_ENABLED="FALSE"
export TEST_CLIENT_VCPU_0_IN_CORE="0"
export TEST_CLIENT_VCPU_0_IN_SOCKET="0"
export TEST_CLIENT_VCPU_0_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_1_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_1_IN_CORE="1"
export TEST_CLIENT_VCPU_1_IN_SOCKET="0"
export TEST_CLIENT_VCPU_1_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_2_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_2_IN_CORE="2"
export TEST_CLIENT_VCPU_2_IN_SOCKET="0"
export TEST_CLIENT_VCPU_2_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_3_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_3_IN_CORE="3"
export TEST_CLIENT_VCPU_3_IN_SOCKET="0"
export TEST_CLIENT_VCPU_3_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_4_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_4_IN_CORE="4"
export TEST_CLIENT_VCPU_4_IN_SOCKET="0"
export TEST_CLIENT_VCPU_4_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_5_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_5_IN_CORE="5"
export TEST_CLIENT_VCPU_5_IN_SOCKET="0"
export TEST_CLIENT_VCPU_5_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_6_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_6_IN_CORE="6"
export TEST_CLIENT_VCPU_6_IN_SOCKET="0"
export TEST_CLIENT_VCPU_6_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_7_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_7_IN_CORE="7"
export TEST_CLIENT_VCPU_7_IN_SOCKET="0"
export TEST_CLIENT_VCPU_7_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_8_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_8_IN_CORE="0"
export TEST_CLIENT_VCPU_8_IN_SOCKET="0"
export TEST_CLIENT_VCPU_8_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_9_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_9_IN_CORE="1"
export TEST_CLIENT_VCPU_9_IN_SOCKET="0"
export TEST_CLIENT_VCPU_9_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_10_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_10_IN_CORE="2"
export TEST_CLIENT_VCPU_10_IN_SOCKET="0"
export TEST_CLIENT_VCPU_10_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_11_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_11_IN_CORE="3"
export TEST_CLIENT_VCPU_11_IN_SOCKET="0"
export TEST_CLIENT_VCPU_11_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_12_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_12_IN_CORE="4"
export TEST_CLIENT_VCPU_12_IN_SOCKET="0"
export TEST_CLIENT_VCPU_12_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_13_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_13_IN_CORE="5"
export TEST_CLIENT_VCPU_13_IN_SOCKET="0"
export TEST_CLIENT_VCPU_13_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_14_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_14_IN_CORE="6"
export TEST_CLIENT_VCPU_14_IN_SOCKET="0"
export TEST_CLIENT_VCPU_14_ON_NUMA_NODE="0"
export TEST_CLIENT_VCPU_15_SOFT_ENABLED="TRUE"
export TEST_CLIENT_VCPU_15_IN_CORE="7"
export TEST_CLIENT_VCPU_15_IN_SOCKET="0"
export TEST_CLIENT_VCPU_15_ON_NUMA_NODE="0"

# -----------------------------------------------------------
# SERVER CONFIGS
# -----------------------------------------------------------
export TEST_SERVER_DPDK_NIC_DEVICE="0"
export TEST_SERVER_DPDK_NIC_DEVICE_NUMA_NODE="0"
export TEST_SERVER_DPDK_NIC_DEVICE_SOFT_ENABLED="TRUE"
export TEST_SERVER_DPDK_NIC_DEVICE_PCI_DEVICE_ID="0000:01:00.1"

export TEST_SERVER_DPDK_NIC_DEVICE_MEMZONE_RESERVE_KB="153600"
export TEST_SERVER_DPDK_NIC_DEVICE_MEMZONE_RESERVE_MASK="5"
export TEST_SERVER_DPDK_NIC_DEVICE_MEMZONE_RESERVE_NAME="REINVENT_AWS"
export TEST_SERVER_DPDK_NIC_DEVICE_MEMPOOL_POLICY="PER_QUEUE"

export TEST_SERVER_DPDK_NIC_DEVICE_MEMPOOL_RXQ_SIZE="2048,2048,2048,2048,2048,2048,2048,2048"
export TEST_SERVER_DPDK_NIC_DEVICE_MEMPOOL_RXQ_CACHE_SIZE="0,0,0,0,0,0,0,0"
export TEST_SERVER_DPDK_NIC_DEVICE_MEMPOOL_RXQ_PRIV_SIZE="0,0,0,0,0,0,0,0"
export TEST_SERVER_DPDK_NIC_DEVICE_MEMPOOL_RXQ_DATA_ROOM_SIZE="2048,2048,2048,2048,2048,2048,2048,2048"

export TEST_SERVER_DPDK_NIC_DEVICE_MEMPOOL_TXQ_SIZE="0"
export TEST_SERVER_DPDK_NIC_DEVICE_MEMPOOL_TXQ_CACHE_SIZE="0"
export TEST_SERVER_DPDK_NIC_DEVICE_MEMPOOL_TXQ_PRIV_SIZE="0"
export TEST_SERVER_DPDK_NIC_DEVICE_MEMPOOL_TXQ_DATA_ROOM_SIZE="0"

export TEST_SERVER_DPDK_NIC_DEVICE_TXQ_VCPU_POLICY="OFF"
export TEST_SERVER_DPDK_NIC_DEVICE_TXQ_VCPU_MASK="ALL"
export TEST_SERVER_DPDK_NIC_DEVICE_TX_QUEUE_SIZE="0"
export TEST_SERVER_DPDK_NIC_DEVICE_TX_MQ_MASK="0"
export TEST_SERVER_DPDK_NIC_DEVICE_TX_OFFLOAD_MASK="0"
export TEST_SERVER_DPDK_NIC_DEVICE_TXQ_RING_SIZE="0"
export TEST_SERVER_DPDK_NIC_DEVICE_TXQ_THREAD_COUNT="0"

export TEST_SERVER_DPDK_NIC_DEVICE_RXQ_VCPU_POLICY="DISTINCT"
export TEST_SERVER_DPDK_NIC_DEVICE_RXQ_VCPU_MASK="ALL"
export TEST_SERVER_DPDK_NIC_DEVICE_RX_QUEUE_SIZE="8"
export TEST_SERVER_DPDK_NIC_DEVICE_RX_MQ_MASK="1"
export TEST_SERVER_DPDK_NIC_DEVICE_RX_OFFLOAD_MASK="0"
export TEST_SERVER_DPDK_NIC_DEVICE_RXQ_RING_SIZE="1024"
export TEST_SERVER_DPDK_NIC_DEVICE_RXQ_THREAD_COUNT="8"

# https://www.ndsl.kaist.edu/~kyoungsoo/papers/TR-symRSS.pdf
# https://medium.com/@anubhavchoudhary/introduction-to-receive-side-scaling-rss-7cd97307d220
export TEST_SERVER_DPDK_NIC_DEVICE_RX_RSS_KEY="6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:6d:5a:"
export TEST_SERVER_DPDK_NIC_DEVICE_RX_RSS_HF="41868"

export TEST_SERVER_DPDK_NIC_DEVICE_RXQ_PTHRESH="8"
export TEST_SERVER_DPDK_NIC_DEVICE_RXQ_HTHRESH="8"
export TEST_SERVER_DPDK_NIC_DEVICE_RXQ_WTHRESH="0"
export TEST_SERVER_DPDK_NIC_DEVICE_RXQ_FREE_THRESH="32"

export TEST_SERVER_DPDK_NIC_DEVICE_RX_MTU="1500"
export TEST_SERVER_DPDK_NIC_DEVICE_LINK_SPEED_MASK="0"
export TEST_SERVER_DPDK_NIC_DEVICE_TX_DEFAULT_FLOW="2048"

export TEST_SERVER_DPDK_NIC_DEVICE_TXQ_DEFAULT_SRC_MAC=""
export TEST_SERVER_DPDK_NIC_DEVICE_TXQ_DEFAULT_DST_MAC=""
export TEST_SERVER_DPDK_NIC_DEVICE_TXQ_DEFAULT_SRC_IP=""
export TEST_SERVER_DPDK_NIC_DEVICE_TXQ_DEFAULT_DST_IP=""
export TEST_SERVER_DPDK_NIC_DEVICE_TXQ_DEFAULT_SRC_PORT=""
export TEST_SERVER_DPDK_NIC_DEVICE_TXQ_DEFAULT_DST_PORT=""

export TEST_SERVER_DPDK_INITIALIZATION_PARAMETERS="--proc-type,primary,--in-memory,--log-level,7,--allow,${TEST_SERVER_DPDK_NIC_DEVICE_PCI_DEVICE_ID}"

export TEST_SERVER_DRAM_MEMORY_CHANNELS=4

export TEST_SERVER_VCPU_MAX=16
export TEST_SERVER_VCPU_0_SOFT_ENABLED="FALSE"
export TEST_SERVER_VCPU_0_IN_CORE="0"
export TEST_SERVER_VCPU_0_IN_SOCKET="0"
export TEST_SERVER_VCPU_0_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_1_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_1_IN_CORE="1"
export TEST_SERVER_VCPU_1_IN_SOCKET="0"
export TEST_SERVER_VCPU_1_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_2_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_2_IN_CORE="2"
export TEST_SERVER_VCPU_2_IN_SOCKET="0"
export TEST_SERVER_VCPU_2_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_3_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_3_IN_CORE="3"
export TEST_SERVER_VCPU_3_IN_SOCKET="0"
export TEST_SERVER_VCPU_3_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_4_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_4_IN_CORE="4"
export TEST_SERVER_VCPU_4_IN_SOCKET="0"
export TEST_SERVER_VCPU_4_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_5_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_5_IN_CORE="5"
export TEST_SERVER_VCPU_5_IN_SOCKET="0"
export TEST_SERVER_VCPU_5_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_6_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_6_IN_CORE="6"
export TEST_SERVER_VCPU_6_IN_SOCKET="0"
export TEST_SERVER_VCPU_6_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_7_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_7_IN_CORE="7"
export TEST_SERVER_VCPU_7_IN_SOCKET="0"
export TEST_SERVER_VCPU_7_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_8_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_8_IN_CORE="0"
export TEST_SERVER_VCPU_8_IN_SOCKET="0"
export TEST_SERVER_VCPU_8_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_9_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_9_IN_CORE="1"
export TEST_SERVER_VCPU_9_IN_SOCKET="0"
export TEST_SERVER_VCPU_9_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_10_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_10_IN_CORE="2"
export TEST_SERVER_VCPU_10_IN_SOCKET="0"
export TEST_SERVER_VCPU_10_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_11_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_11_IN_CORE="3"
export TEST_SERVER_VCPU_11_IN_SOCKET="0"
export TEST_SERVER_VCPU_11_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_12_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_12_IN_CORE="4"
export TEST_SERVER_VCPU_12_IN_SOCKET="0"
export TEST_SERVER_VCPU_12_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_13_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_13_IN_CORE="5"
export TEST_SERVER_VCPU_13_IN_SOCKET="0"
export TEST_SERVER_VCPU_13_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_14_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_14_IN_CORE="6"
export TEST_SERVER_VCPU_14_IN_SOCKET="0"
export TEST_SERVER_VCPU_14_ON_NUMA_NODE="0"
export TEST_SERVER_VCPU_15_SOFT_ENABLED="TRUE"
export TEST_SERVER_VCPU_15_IN_CORE="7"
export TEST_SERVER_VCPU_15_IN_SOCKET="0"
export TEST_SERVER_VCPU_15_ON_NUMA_NODE="0"

# run task
if [[ "$MODE" == "client" ]]
then
  echo $TASK -m $MODE -p $PREFIX $ARGS
  # gdb --args $TASK -m $MODE -p $PREFIX $ARGS
  $TASK -m $MODE -p $PREFIX $ARGS
else
  echo $TASK -m $MODE -p $PREFIX $ARGS
  # gdb --args $TASK -m $MODE -p $PREFIX $ARGS
  $TASK -m $MODE -p $PREFIX $ARGS
fi
